general:
  branches:
    ignore:
      - /feature\/.*/
machine:
  python:
    version: 2.7.12
  environment:
    CUMULUSCI_KEY: FIXME
    CUMULUSCI_KEYCHAIN_CLASS: cumulusci.core.keychain.EnvironmentProjectKeychain
dependencies:
  override:
    #- 'pip install --upgrade cumulusci'
    - 'git clone git@github.com:SalesforceFoundation/CumulusCI'
    - 'git checkout feature/2.0'
    - 'pip install -r requirements_dev.txt'
  post:
    - '[[ $CIRCLE_BRANCH == "master" ]] && cumulusci2 flow run --org packaging ci_master || cumulusci2 flow run --org feature ci_feature'
    - '[[ $CIRCLE_BRANCH == "master" ]] && cumulusci2 flow run --org packaging release_beta || echo "Skipping upload_beta step for branch $CIRCLE_BRANCH"'
test:
  override:
    - '[[ $CIRCLE_BRANCH == "master" ]] && cumulusci2 flow run ci_beta -o version FIXME --run-tests || echo "Skipping beta_deploy step for branch $CIRCLE_BRANCH"'
    - '[[ $CIRCLE_BRANCH == "master" ]] && echo "Skipping unmanaged run_tests step for branch $CIRCLE_BRANCH" || cumulusci2 dev run_tests_debug --debug-logdir apex_tests_db --json-output test_results.json'
  post:
    - 'mkdir -p $CIRCLE_TEST_REPORTS/junit/'
    - 'cp test_results.xml $CIRCLE_TEST_REPORTS/junit/'
    - '[[ $CIRCLE_BRANCH == "master" ]] && echo "Skipping unmanaged run_tests step for branch $CIRCLE_BRANCH" || cp test_results.json $CIRCLE_ARTIFACTS'
    - '[[ $CIRCLE_BRANCH == "master" ]] && echo "Skipping unmanaged run_tests step for branch $CIRCLE_BRANCH" || cumulusci2 task run apextestsdb_upload'
deployment:
  master_to_feature:
    branch: master
    commands:
      - 'cumulusci2 task run github_master_to_feature'
